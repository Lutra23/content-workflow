# NanGePlus AI Agent æ·±åº¦æŠ€æœ¯æ¶æ„åˆ†æ

**åˆ†ææ—¥æœŸ**: 2026-01-31
**ä½œè€…**: lutra ğŸ¦¦
**ç›®æ ‡**: æŒæ¡ç”Ÿäº§çº§ AI Agent ç³»ç»Ÿçš„å®Œæ•´æ¶æ„

---

## ä¸€ã€é¡¹ç›®æ¶æ„å…¨æ™¯

### 1.1 æ ¸å¿ƒé¡¹ç›®å®šä½

| é¡¹ç›® | æ¡†æ¶ | æ ¸å¿ƒåŠŸèƒ½ | å¤æ‚åº¦ |
|------|------|----------|--------|
| LangGraphChatBot | LangGraph | å¸¦è®°å¿†çš„å¯¹è¯æœºå™¨äºº | â­â­â­â­ |
| CrewAITest | CrewAI | å¤š Agent åä½œ | â­â­â­â­ |
| GraphragTest | GraphRAG | çŸ¥è¯†å›¾è°± RAG | â­â­â­â­â­ |
| ReActAgentsTest | LangGraph+ReAct | MCP å·¥å…·é›†æˆ | â­â­â­ |

### 1.2 æŠ€æœ¯æ ˆçŸ©é˜µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨å±‚ (Application)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Gradio WebUI  â”‚   FastAPI     â”‚     CLI / Script         â”‚
â”‚   (ç”¨æˆ·ç•Œé¢)    â”‚   (APIæœåŠ¡)    â”‚     (è„šæœ¬å…¥å£)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    ç¼–æ’å±‚ (Orchestration)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   LangGraph    â”‚    CrewAI      â”‚     ReAct Pattern        â”‚
â”‚   (çŠ¶æ€å›¾)     â”‚   (å¤šAgent)    â”‚     (æ¨ç†-è¡ŒåŠ¨å¾ªç¯)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      æ ¸å¿ƒå±‚ (Core)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   LangChain    â”‚   è®°å¿†ç³»ç»Ÿ     â”‚     å·¥å…·ç³»ç»Ÿ             â”‚
â”‚   (LLMæŠ½è±¡)    â”‚  (Postgres)    â”‚     (MCP/Tools)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    æ¨¡å‹å±‚ (Models)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   OpenAI       â”‚  å›½äº§å¤§æ¨¡å‹    â”‚     æœ¬åœ°æ¨¡å‹             â”‚
â”‚   (GPT-4o)     â”‚  (é€šä¹‰/æ™ºè°±)    â”‚     (Ollama)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€LangGraph æ ¸å¿ƒæ¶æ„è¯¦è§£

### 2.1 çŠ¶æ€ç®¡ç† (State Management)

```python
# 1. çŠ¶æ€å®šä¹‰ - TypedDict + Annotated
from typing import TypedDict, Annotated, Sequence, Optional
from langchain_core.messages import BaseMessage
from langgraph.graph.message import add_messages

class MessagesState(TypedDict):
    """æ ¸å¿ƒçŠ¶æ€ç±»å‹"""
    messages: Annotated[Sequence[BaseMessage], add_messages]
    relevance_score: Annotated[Optional[str], "æ–‡æ¡£ç›¸å…³æ€§è¯„åˆ†"]
    rewrite_count: Annotated[int, "é—®é¢˜é‡å†™æ¬¡æ•°"]

# 2. çŠ¶æ€æµåŠ¨
"""
ç”¨æˆ·è¾“å…¥ â†’ agent(åˆ†æ) â†’ å·¥å…·è°ƒç”¨ â†’ grade(è¯„åˆ†) â†’ generate(ç”Ÿæˆ)
     â†“              â†“           â†“           â†“           â†“
  [messages]    [messages]  [messages]  [relevance]  [messages]
     â†“              â†“           â†“           â†“           â†“
"""

# 3. çŠ¶æ€æŒä¹…åŒ–
from langgraph.checkpoint.postgres import PostgresSaver
from langgraph.store.postgres import PostgresStore

# çº¿ç¨‹å†…æŒä¹…åŒ–ï¼ˆå¯¹è¯è¿ç»­æ€§ï¼‰
checkpointer = PostgresSaver(pool)
app = graph.compile(checkpointer=checkpointer)

# è·¨çº¿ç¨‹æŒä¹…åŒ–ï¼ˆé•¿æœŸè®°å¿†ï¼‰
store = PostgresStore(pool)
store.put(namespace, key, {"data": memory})
```

### 2.2 èŠ‚ç‚¹è®¾è®¡æ¨¡å¼

```python
# æ¨¡å¼1: çº¯LLMèŠ‚ç‚¹
def agent_node(state: MessagesState, config) -> dict:
    """åˆ†æç”¨æˆ·æ„å›¾ï¼Œå†³å®šä¸‹ä¸€æ­¥"""
    response = llm.invoke(state["messages"])
    return {"messages": [response]}

# æ¨¡å¼2: å·¥å…·è°ƒç”¨èŠ‚ç‚¹
from langgraph.prebuilt import ToolNode, tools_condition

def call_tools(state: MessagesState):
    """å¹¶è¡Œæ‰§è¡Œå·¥å…·è°ƒç”¨"""
    return state  # ToolNode è‡ªåŠ¨å¤„ç†

# æ¨¡å¼3: æ¡ä»¶è·¯ç”±èŠ‚ç‚¹
def route_after_tools(state: MessagesState) -> str:
    """æ ¹æ®å·¥å…·è°ƒç”¨ç»“æœå†³å®šä¸‹ä¸€æ­¥"""
    if state.get("relevance_score") == "yes":
        return "generate"
    return "rewrite"
```

### 2.3 å›¾æ„å»ºæ¨¡å¼

```python
from langgraph.graph import StateGraph, START, END

# 1. åˆ›å»ºçŠ¶æ€å›¾
graph = StateGraph(MessagesState)

# 2. æ·»åŠ èŠ‚ç‚¹
graph.add_node("agent", agent_node)
graph.add_node("tools", ToolNode(tools))
graph.add_node("grade_documents", grade_node)
graph.add_node("generate", generate_node)
graph.add_node("rewrite", rewrite_node)

# 3. æ·»åŠ è¾¹ï¼ˆå›ºå®šæµç¨‹ï¼‰
graph.add_edge(START, "agent")
graph.add_edge("tools", "grade_documents")
graph.add_edge("generate", END)

# 4. æ·»åŠ æ¡ä»¶è¾¹ï¼ˆåŠ¨æ€è·¯ç”±ï¼‰
graph.add_conditional_edges(
    "agent",
    tools_condition,  # è·¯ç”±å‡½æ•°
    {
        "tools": "tools",
        "__end__": END
    }
)

graph.add_conditional_edges(
    "grade_documents",
    route_after_grade,  # è‡ªå®šä¹‰è·¯ç”±
    {
        "generate": "generate",
        "rewrite": "rewrite"
    }
)

# 5. ç¼–è¯‘å›¾
app = graph.compile()
```

### 2.4 é«˜çº§ç‰¹æ€§

```python
# 1. å¹¶è¡Œå·¥å…·æ‰§è¡Œ
from concurrent.futures import ThreadPoolExecutor

class ParallelToolNode:
    def __init__(self, max_workers=5):
        self.max_workers = max_workers
    
    def execute(self, tool_calls):
        with ThreadPoolExecutor(max_workers=self.max_workers) as executor:
            futures = [executor.submit(tool.invoke, call) for call in tool_calls]
            return [f.result() for f in as_completed(futures)]

# 2. å¯è§†åŒ–
def save_graph_visualization(graph, filename="graph.png"):
    with open(filename, "wb") as f:
        f.write(graph.get_graph().draw_mermaid_png())

# 3. çŠ¶æ€å¿«ç…§
def save_checkpoint(app, thread_id):
    config = {"configurable": {"thread_id": thread_id}}
    return app.get_state(config)
```

---

## ä¸‰ã€å¤šæ¨¡å‹æ”¯æŒæ¶æ„

### 3.1 æ¨¡å‹é…ç½®æŠ½è±¡

```python
# é…ç½®å³ä»£ç 
MODEL_CONFIGS = {
    "openai": {
        "base_url": "https://api.openai.com/v1",
        "api_key": "sk-...",
        "chat_model": "gpt-4o-mini",
        "embedding_model": "text-embedding-3-small"
    },
    "qwen": {
        "base_url": "https://dashscope.aliyuncs.com/compatible-mode/v1",
        "api_key": "sk-...",
        "chat_model": "qwen-max",
        "embedding_model": "text-embedding-v1"
    },
    "ollama": {
        "base_url": "http://localhost:11434/v1",
        "api_key": "ollama",
        "chat_model": "llama3.1:8b",
        "embedding_model": "nomic-embed-text:latest"
    }
}

# ç»Ÿä¸€åˆå§‹åŒ–æ¥å£
def get_llm(llm_type: str = "openai") -> ChatOpenAI:
    config = MODEL_CONFIGS[llm_type]
    return ChatOpenAI(
        base_url=config["base_url"],
        api_key=config["api_key"],
        model=config["chat_model"],
        temperature=0.7,
        timeout=30,
        max_retries=2
    )
```

### 3.2 æ¨¡å‹åˆ‡æ¢ç­–ç•¥

```python
# ç­–ç•¥1: é…ç½®é©±åŠ¨
LLM_TYPE = os.getenv("LLM_TYPE", "openai")

# ç­–ç•¥2: æ•…éšœè½¬ç§»
def get_llm_with_fallback(primary: str, fallback: str):
    try:
        return initialize_llm(primary)
    except Exception:
        return initialize_llm(fallback)

# ç­–ç•¥3: æˆæœ¬ä¼˜åŒ–
def select_model(task_type: str) -> str:
    if task_type == "simple_reasoning":
        return "qwen-max"  # ä¾¿å®œ
    elif task_type == "complex_coding":
        return "gpt-4o"    # èƒ½åŠ›å¼º
```

---

## å››ã€å·¥å…·ç³»ç»Ÿè®¾è®¡

### 4.1 å·¥å…·å®šä¹‰æ¨¡å¼

```python
# æ–¹å¼1: LangChain @tool è£…é¥°å™¨
from langchain_core.tools import tool

@tool
def multiply(a: float, b: float) -> float:
    """è®¡ç®—ä¸¤ä¸ªæ•°çš„ä¹˜ç§¯"""
    return a * b

# æ–¹å¼2: create_retriever_tool
from langchain.tools.retriever import create_retriever_tool

retriever_tool = create_retriever_tool(
    retriever,
    name="retrieve",
    description="æœç´¢å¹¶è¿”å›ç›¸å…³ä¿¡æ¯"
)

# æ–¹å¼3: MCP å·¥å…·é›†æˆ
from langchain_mcp_adapters.client import MultiServerMCPClient

client = MultiServerMCPClient({
    "amap": {
        "command": ["npx", "-y", "@amap-mcp/server"],
        "env": {"AMAP_API_KEY": "your-key"}
    }
})

tools = await client.get_tools()
```

### 4.2 å·¥å…·è·¯ç”±é…ç½®

```python
class ToolConfig:
    def __init__(self, tools):
        self.tools = tools
        self.tool_names = {tool.name for tool in tools}
        self.routing_config = self._build_routing()
    
    def _build_routing(self):
        """æ ¹æ®å·¥å…·ç±»å‹åŠ¨æ€è·¯ç”±"""
        routing = {}
        for tool in self.tools:
            if "retrieve" in tool.name.lower():
                routing[tool.name] = "grade_documents"  # RAG ç±»
            else:
                routing[tool.name] = "generate"         # ç›´æ¥ç”Ÿæˆ
        return routing
```

### 4.3 MCP Server é›†æˆ

```python
# é«˜å¾·åœ°å›¾ MCP Server ç¤ºä¾‹
MCP_TOOLS = [
    {"name": "maps_regeocode", "desc": "ç»çº¬åº¦è½¬åœ°å€"},
    {"name": "maps_geo", "desc": "åœ°å€è½¬ç»çº¬åº¦"},
    {"name": "maps_weather", "desc": "å¤©æ°”æŸ¥è¯¢"},
    {"name": "maps_direction_driving", "desc": "é©¾è½¦è§„åˆ’"},
    {"name": "maps_text_search", "desc": "å…³é”®è¯æœç´¢"},
    # ... 12ä¸ªæ ¸å¿ƒæœåŠ¡
]

# ä½¿ç”¨æ–¹å¼
agent = create_react_agent(llm, mcp_tools)
result = agent.invoke({"messages": [HumanMessage(content="ä»åŒ—äº¬å¤§å­¦æ€ä¹ˆå»å¤©å®‰é—¨")]})
```

---

## äº”ã€è®°å¿†ç³»ç»Ÿæ¶æ„

### 5.1 å¤šå±‚è®°å¿†æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é•¿æœŸè®°å¿† (Long-term)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  PostgreSQL Store                               â”‚   â”‚
â”‚  â”‚  - ç”¨æˆ·ä¿¡æ¯                                     â”‚   â”‚
â”‚  â”‚  - å†å²å¯¹è¯                                     â”‚   â”‚
â”‚  â”‚  - åå¥½è®¾ç½®                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    çŸ­æœŸè®°å¿† (Short-term)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Graph State                                    â”‚   â”‚
â”‚  â”‚  - å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡                               â”‚   â”‚
â”‚  â”‚  - å·¥å…·è°ƒç”¨ç»“æœ                                 â”‚   â”‚
â”‚  â”‚  - ä¸­é—´æ¨ç†ç»“æœ                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    å·¥ä½œè®°å¿† (Working)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  LLM Context                                    â”‚   â”‚
â”‚  â”‚  - ç³»ç»Ÿæç¤ºè¯                                   â”‚   â”‚
â”‚  â”‚  - few-shot ç¤ºä¾‹                                â”‚   â”‚
â”‚  â”‚  - å®æ—¶ä¸Šä¸‹æ–‡                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å®ç°ä»£ç 

```python
# é•¿æœŸè®°å¿†å­˜å‚¨
def store_memory(question, config, store: BaseStore):
    namespace = ("memories", config["configurable"]["user_id"])
    
    # è§¦å‘å­˜å‚¨
    if "è®°ä½" in question.content.lower():
        store.put(namespace, str(uuid.uuid4()), {
            "data": question.content,
            "timestamp": datetime.now().isoformat()
        })
    
    # æ£€ç´¢è®°å¿†
    memories = store.search(namespace, query=question.content)
    return "\n".join([m.value["data"] for m in memories])

# çŸ­æœŸè®°å¿†ç®¡ç†
def filter_messages(messages):
    """è¿‡æ»¤æ¶ˆæ¯ï¼Œä¿ç•™æœ€è¿‘ N æ¡"""
    filtered = []
    for msg in messages:
        if isinstance(msg, (AIMessage, HumanMessage)):
            filtered.append(msg)
    return filtered[-5:]  # åªä¿ç•™æœ€è¿‘5æ¡
```

---

## å…­ã€Prompt Engineering æœ€ä½³å®è·µ

### 6.1 Agent Prompt ç»“æ„

```python
# æç¤ºè¯æ¨¡æ¿ç»„æˆ
PROMPT_AGENT = """
# è§’è‰²å®šä¹‰
ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ï¼Œè´Ÿè´£åˆ†æç”¨æˆ·é—®é¢˜å¹¶åŒ¹é…æœ€åˆé€‚çš„å·¥å…·ã€‚

# å¯ç”¨å·¥å…·
1. å¥åº·æ¡£æ¡ˆæŸ¥è¯¢å·¥å…· - æœç´¢å¥åº·æ¡£æ¡ˆä¿¡æ¯
2. è®¡ç®—å·¥å…· - æ‰§è¡Œæ•°å­¦è®¡ç®—

# ä»»åŠ¡è¯´æ˜
1. åˆ†æç”¨æˆ·æ„å›¾
2. åˆ¤æ–­æ˜¯å¦éœ€è¦å·¥å…·
3. å¦‚æœéœ€è¦ï¼Œé€‰æ‹©æ­£ç¡®çš„å·¥å…·
4. å¦‚æœä¸éœ€è¦ï¼Œç›´æ¥å›ç­”

# çº¦æŸæ¡ä»¶
- ä¸è¦å‡è®¾ç”¨æˆ·éœ€æ±‚
- å¦‚æœé—®é¢˜æ¶‰åŠæ•æ„Ÿå†…å®¹ï¼Œæ‹’ç»å›ç­”
- ä¿æŒå›ç­”ç®€æ´æ¸…æ™°

# å½“å‰å¯¹è¯
{question}
{context}
"""
```

### 6.2 RAG Prompt æ¨¡æ¿

```python
# ç›¸å…³æ€§è¯„åˆ†
PROMPT_GRADE = """
ä½ æ˜¯ä¸€åè¯„åˆ†å‘˜ï¼Œè¯„ä¼°æ–‡æ¡£ä¸é—®é¢˜çš„ç›¸å…³æ€§ã€‚

é—®é¢˜: {question}
æ–‡æ¡£: {context}

å¦‚æœæ–‡æ¡£åŒ…å«ç›¸å…³ä¿¡æ¯ï¼Œè¿”å› "yes"ï¼Œå¦åˆ™è¿”å› "no"ã€‚
åªè¿”å› "yes" æˆ– "no"ã€‚
"""

# é—®é¢˜é‡å†™
PROMPT_REWRITE = """
å°†ç”¨æˆ·é—®é¢˜é‡å†™ä¸ºæ›´å…·ä½“ã€æ›´æœ‰æ•ˆçš„æœç´¢æŸ¥è¯¢ã€‚

åŸå§‹é—®é¢˜: {question}

é‡å†™åçš„é—®é¢˜ï¼ˆåªè¾“å‡ºé—®é¢˜ï¼‰ï¼š
"""
```

### 6.3 å¤šç‰ˆæœ¬ç®¡ç†

```
prompts/
â”œâ”€â”€ v1/
â”‚   â”œâ”€â”€ agent.txt
â”‚   â”œâ”€â”€ grade.txt
â”‚   â””â”€â”€ generate.txt
â”œâ”€â”€ v2/
â”‚   â”œâ”€â”€ agent.txt
â”‚   â”œâ”€â”€ grade.txt
â”‚   â””â”€â”€ generate.txt
â””â”€â”€ template.yaml  # ç‰ˆæœ¬é…ç½®
```

---

## ä¸ƒã€æ•°æ®åº“æ¶æ„

### 7.1 è¿æ¥æ± ç®¡ç†

```python
from psycopg_pool import ConnectionPool

# è¿æ¥æ± é…ç½®
pool = ConnectionPool(
    conninfo=DB_URI,
    min_size=2,
    max_size=20,
    max_lifetime=3600,
    max_idle=600,
    timeout=30
)

# å¥åº·æ£€æŸ¥
@retry(stop=stop_after_attempt(3), wait=wait_exponential())
def test_connection():
    with pool.getconn() as conn:
        with conn.cursor() as cursor:
            cursor.execute("SELECT 1")

# ç›‘æ§
def monitor_pool(pool, interval=60):
    while not pool.closed:
        stats = pool.get_stats()
        logger.info(f"Pool: {stats['connections_in_use']}/{pool.max_size}")
        time.sleep(interval)
```

### 7.2 è¡¨ç»“æ„

```sql
-- å¯¹è¯å†å²è¡¨
CREATE TABLE conversations (
    id UUID PRIMARY KEY,
    user_id UUID,
    thread_id UUID,
    messages JSONB,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

-- è®°å¿†è¡¨
CREATE TABLE memories (
    id UUID PRIMARY KEY,
    user_id UUID,
    namespace TEXT,
    key TEXT,
    value JSONB,
    created_at TIMESTAMP
);

-- æ£€æŸ¥ç‚¹è¡¨
CREATE TABLE checkpoints (
    thread_id TEXT,
    checkpoint_id TEXT,
    metadata JSONB,
    state JSONB,
    PRIMARY KEY (thread_id, checkpoint_id)
);
```

---

## å…«ã€API æœåŠ¡æ¶æ„

### 8.1 FastAPI å°è£…

```python
from fastapi import FastAPI, HTTPException
from pydantic import BaseModel

app = FastAPI(title="Agent API")

class ChatRequest(BaseModel):
    message: str
    user_id: str
    thread_id: str = None

class ChatResponse(BaseModel):
    response: str
    thread_id: str

@app.post("/chat")
async def chat(request: ChatRequest):
    config = {"configurable": {"user_id": request.user_id}}
    
    # åˆ›å»ºæ–° thread æˆ–æ¢å¤
    if request.thread_id:
        config["configurable"]["thread_id"] = request.thread_id
    
    # è°ƒç”¨ Agent
    result = app.invoke(
        {"messages": [HumanMessage(content=request.message)]},
        config=config
    )
    
    return ChatResponse(
        response=result["messages"][-1].content,
        thread_id=config["configurable"]["thread_id"]
    )
```

### 8.2 Gradio å‰ç«¯

```python
import gradio as gr

with gr.Blocks() as demo:
    chatbot = gr.Chatbot()
    msg = gr.Textbox()
    
    def respond(message, history):
        response = call_api(message)
        history.append((message, response))
        return "", history
    
    msg.submit(respond, [msg, chatbot], [msg, chatbot])

demo.launch(server_name="0.0.0.0", server_port=7860)
```

---

## ä¹ã€å·¥ç¨‹å®è·µæ€»ç»“

### 9.1 ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥æ¸…å•

```python
CHECKLIST = {
    "åŸºç¡€é…ç½®": [
        "âœ… ç¯å¢ƒå˜é‡ç®¡ç†",
        "âœ… é…ç½®ä¸ä»£ç åˆ†ç¦»",
        "âœ… å¤šæ¨¡å‹é…ç½®æŠ½è±¡"
    ],
    "æ€§èƒ½ä¼˜åŒ–": [
        "âœ… è¿æ¥æ± é…ç½®",
        "âœ… å¹¶å‘æ§åˆ¶",
        "âœ… ç¼“å­˜ç­–ç•¥"
    ],
    "å¯é æ€§": [
        "âœ… é‡è¯•æœºåˆ¶",
        "âœ… æ—¥å¿—è®°å½•",
        "âœ… é”™è¯¯æ¢å¤"
    ],
    "å¯è§‚æµ‹æ€§": [
        "âœ… çŠ¶æ€ç›‘æ§",
        "âœ… æ—¥å¿—è½®è½¬",
        "âœ… é“¾è·¯è¿½è¸ª"
    ]
}
```

### 9.2 å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| ä¸Šä¸‹æ–‡ä¸¢å¤± | æ£€æŸ¥ç‚¹æœªæŒä¹…åŒ– | ä½¿ç”¨ PostgresSaver |
| å·¥å…·è°ƒç”¨å¤±è´¥ | è¶…æ—¶/ç½‘ç»œ | é‡è¯•æœºåˆ¶ + è¶…æ—¶é…ç½® |
| å“åº”å»¶è¿Ÿé«˜ | ä¸Šä¸‹æ–‡è¿‡é•¿ | æ¶ˆæ¯è¿‡æ»¤ + æ‘˜è¦ |
| å†…å­˜æº¢å‡º | è¿æ¥æ± æ³„æ¼ | ç›‘æ§ + è‡ªåŠ¨æ¸…ç† |
| æ¨¡å‹å¹»è§‰ | Prompt ä¸æ¸…æ™° | çº¦æŸæ¡ä»¶ + ç¤ºä¾‹ |

### 9.3 æ‰©å±•æ€§è®¾è®¡

```python
# æ’ä»¶åŒ–å·¥å…·æ³¨å†Œ
class ToolRegistry:
    _tools = {}
    
    @classmethod
    def register(cls, name):
        def decorator(func):
            cls._tools[name] = func
            return func
        return decorator
    
    @classmethod
    def get_tool(cls, name):
        return cls._tools.get(name)

# ä½¿ç”¨
@ToolRegistry.register("custom_tool")
def my_tool(input):
    return process(input)
```

---

## åã€å­¦ä¹ è·¯å¾„å»ºè®®

### 10.1 æ¸è¿›å¼å­¦ä¹ 

```
Week 1: LangChain åŸºç¡€
  â”œâ”€â”€ Prompt Engineering
  â”œâ”€â”€ LLM è°ƒç”¨å°è£…
  â””â”€â”€ ç®€å• Chain æ„å»º

Week 2: LangGraph å…¥é—¨
  â”œâ”€â”€ State & TypedDict
  â”œâ”€â”€ Node & Edge
  â””â”€â”€ åŸºç¡€å›¾æ„å»º

Week 3: å·¥å…·ä¸è®°å¿†
  â”œâ”€â”€ Tool å®šä¹‰ä¸è°ƒç”¨
  â”œâ”€â”€ çŸ­æœŸè®°å¿†ç®¡ç†
  â””â”€â”€ é•¿æœŸè®°å¿†æŒä¹…åŒ–

Week 4: ç”Ÿäº§åŒ–
  â”œâ”€â”€ FastAPI å°è£…
  â”œâ”€â”€ æ•°æ®åº“é›†æˆ
  â””â”€â”€ ç›‘æ§ä¸æ—¥å¿—
```

### 10.2 æ¨èé¡¹ç›®

| é¡¹ç›® | éš¾åº¦ | æ ¸å¿ƒæŠ€èƒ½ |
|------|------|----------|
| åŸºç¡€å¯¹è¯æœºå™¨äºº | â­ | LangChain |
| å¸¦è®°å¿†çš„å®¢æœ | â­â­ | LangGraph State |
| RAG çŸ¥è¯†åº“ | â­â­ | å‘é‡æ£€ç´¢ |
| å¤š Agent åä½œ | â­â­â­ | CrewAI |
| MCP å·¥å…·é›†æˆ | â­â­â­ | å·¥å…·ç³»ç»Ÿ |

---

## åä¸€ã€å…³é”®èµ„æºé“¾æ¥

### æ–‡æ¡£
- LangGraph: https://langchain-ai.github.io/langgraph/
- MCP Protocol: https://modelcontextprotocol.io/
- CrewAI: https://docs.crewai.com/

### å·¥å…·
- é«˜å¾· MCP: https://lbs.amap.com/api/mcp-server/summary
- MCP Servers: https://github.com/modelcontextprotocol/servers

### é¡¹ç›®
- LangGraphChatBot: https://github.com/NanGePlus/LangGraphChatBot
- ReActAgentsTest: https://github.com/NanGePlus/ReActAgentsTest
- CrewAITest: https://github.com/NanGePlus/CrewAITest

---

*æ–‡æ¡£ç”Ÿæˆæ—¶é—´: 2026-01-31*
*æ¥æº: NanGePlus AI Agent å­¦ä¹ *
